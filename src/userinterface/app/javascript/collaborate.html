<!doctype html>
<html>
<head>
    <title>Mimoto Realtime Collaboration</title>

    <link href="https://cdn.quilljs.com/1.2.3/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.2.3/quill.bubble.css" rel="stylesheet">

    <script src="/mimoto.cms.js"></script>

    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background: #fafafa;
        }
        .editor {
            margin: 25px;
            padding: 25px;
            height: 100%;
            border: 1px solid #e5e5e5;
            background-color: #ffffff;
        }

        p {
            line-height: 25px;
            font-size: 14px;
        }
    </style>

    <script>
        window.onload = function()
        {
            var deltaPending = null;
            var documentPending = null;


            var deltaBuffer = null;


            var quill = new Mimoto.modules.Quill('#editor', {
                theme: 'bubble',
                modules: {
                    history: {
                        delay: 2000,
                        maxStack: 500,
                        userOnly: true
                    }
                }
            });


            var socket = io();


            quill.on('text-change', function(delta, oldContents, source)
            {
                if (source == 'api')
                {
                     console.warn("An API call triggered this change.", delta);

                }
                else if (source == 'user')
                {
                    console.log("The user triggered this change.", delta, oldContents);


                    if (!deltaPending && !documentPending)
                    {
                        deltaPending = delta;
                        //documentPending = oldContents;

                        socket.emit('ot', deltaPending);
                    }
                    else
                    {
                        // init
                        if (!deltaBuffer) deltaBuffer = new Mimoto.modules.QuillDelta();

                        // stack
                        deltaBuffer = deltaBuffer.compose(delta);
                    }


                    console.warn('Pending contents = ' + JSON.stringify(deltaPending, null, 2));
                    console.warn('Buffer contents = ' + JSON.stringify(deltaBuffer, null, 2));

                }

                //console.log('change = ' + JSON.stringify(delta, null, 2), '\nprevious contents = ' + JSON.stringify(oldContents, null, 2));

            });

            socket.on('initialContent', function(delta) {
               quill.setContents(delta);
            });

            socket.on('ot-other', function(delta) {

                console.log('OTHER - delta received', delta);

                // 1. check if



                if (deltaPending && documentPending)
                {
                    //var diff = documentPending.transform(delta);


                    //console.error(diff);
                }

                quill.updateContents(delta);
            });

            socket.on('ot-self', function(delta) {

                console.log("SELF = delta received", delta);


                if (deltaPending)
                {

                    if (deltaPending.toString() == delta.toString())
                    {
                        console.log('The deltas are EQUAL', delta);

                        deltaPending  = null;
                    }

                    if (deltaBuffer)
                    {
                        //
                        deltaPending = deltaBuffer;

                        socket.emit('ot', deltaPending);

                        // reset
                        deltaBuffer = null;
                    }
                    else
                    {
                        deltaPending = null;
                        documentPending = null;
                    }
                }

            });
        }
    </script>
</head>

<body>

    <div id="editor" class="editor"></div>

</body>
</html>
