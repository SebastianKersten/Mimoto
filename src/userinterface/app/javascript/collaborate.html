<!doctype html>
<html>
<head>
    <title>Mimoto Realtime Collaboration</title>

    <link href="https://cdn.quilljs.com/1.2.3/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.2.3/quill.bubble.css" rel="stylesheet">

    <script src="/mimoto.cms.js"></script>

    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background: #fafafa;
        }

        div.container {
            position: relative;
            margin: 25px;
            padding: 25px;
            height: 100%;

            border: 1px solid #e5e5e5;
            background-color: #ffffff;
        }

        div.cursors {
            position: absolute;
            height: 100%;
            min-height: 250px;
        }

        div.cursor {
            position: absolute;
            background-color: #FF9999;
            display: inline-block;
        }

        .editor {
            position: relative;
            height: 100%;
            min-height: 250px;
        }

        p {
            line-height: 25px;
            font-size: 14px;
        }

        blockquote {
            max-width: 450px;
            font-size: 32px;
            font-weight: bold;
            color: #b5b3b4;
        }

        .mimoto-infocard {
            color: gray;
            border-radius: 5px;
            border: solid 2px gray;
            padding: 0 5px;
            display: inline-block;

        }
        .mimoto-infocard:hover{
            cursor: none;
        }
    </style>

    <script>
        window.onload = function()
        {
            var deltaPending = null;
            var documentPending = null;


            var deltaBuffer = null;

          var toolbarOptions = [
            ['bold', 'italic'],
            [{'header': 1}, {'header': 2}],
            ['blockquote', 'link'],
            [{'mimoto-infocard': 'infocard'}],
            ['clean']
          ];


            var quill = new Mimoto.modules.Quill('#editor', {
                theme: 'bubble',
                modules: {
                    toolbar: toolbarOptions,
                    history: {
                        delay: 2000,
                        maxStack: 500,
                        userOnly: true
                    }
                }
            });


          // Handlers can also be added post initialization
          var toolbar = quill.getModule('toolbar');

          // @todo maybe add this handler on the mimoto.cms
          toolbar.addHandler('mimoto-infocard', function (value) {
            console.log('New handler for mimoto-infocard');

            // get the position of the cursor
            var range = quill.getSelection();
            var text = quill.getText(range);
//            var contents = quill.getContents(range);
//            var bounds = quill.getBounds(range);
            var blot = quill.getLeaf(range.index);
            var infoCard = blot[0].next;
//            var format = quill.getFormat(range);

//            console.log({value});
//            console.log({range});
//            console.log({text});
//            console.log({contents});
//            console.log({bounds});
//            console.log({blot});
//            console.log({format});

            // insert infocard
            if (range && (range.length > 1 || text !== ' ')) {
              quill.deleteText(range);
              quill.insertEmbed(range.index, "mimoto-infocard", text);
            }

            // remove infocard if this exists
            if(blot && infoCard){
              if(infoCard.domNode.className === 'mimoto-infocard'){

                var parent = infoCard.domNode.parentNode;
                var text = document.createTextNode(infoCard.domNode.innerText);

                parent.replaceChild(text, infoCard.domNode);

              }
            }

          });

            var socket = io();

            quill.on('selection-change', function()
            {
                console.log('selectionChange', quill.getSelection());

                // getBounds
                socket.emit('selectionChange', quill.getSelection());

            });

            quill.on('text-change', function(delta, oldContents, source)
            {
                // getBounds
                socket.emit('selectionChange', quill.getSelection());


                if (source == 'api')
                {
                     console.warn("An API call triggered this change.", delta);

                }
                else if (source == 'user')
                {
                    console.log("The user triggered this change.", delta, oldContents);


                    if (!deltaPending && !documentPending)
                    {
                        deltaPending = delta;
                        //documentPending = oldContents;

                        socket.emit('ot', deltaPending);
                    }
                    else
                    {
                        // init
                        if (!deltaBuffer) deltaBuffer = new Mimoto.modules.QuillDelta();

                        // stack
                        deltaBuffer = deltaBuffer.compose(delta);
                    }


                    console.warn('Pending contents = ' + JSON.stringify(deltaPending, null, 2));
                    console.warn('Buffer contents = ' + JSON.stringify(deltaBuffer, null, 2));

                }

                //console.log('change = ' + JSON.stringify(delta, null, 2), '\nprevious contents = ' + JSON.stringify(oldContents, null, 2));

            });

            socket.on('initialContent', function(delta) {
               quill.setContents(delta);
            });

            socket.on('ot-other', function(delta) {

                console.log('OTHER - delta received', delta);

                // 1. check if



                if (deltaPending && documentPending)
                {
                    //var diff = documentPending.transform(delta);


                    //console.error(diff);
                }

                quill.updateContents(delta);
            });

            socket.on('ot-self', function(delta) {

                console.log("SELF = delta received", delta);


                if (deltaPending)
                {

                    if (deltaPending.toString() == delta.toString())
                    {
                        console.log('The deltas are EQUAL', delta);

                        deltaPending  = null;
                    }

                    if (deltaBuffer)
                    {
                        //
                        deltaPending = deltaBuffer;

                        socket.emit('ot', deltaPending);

                        // reset
                        deltaBuffer = null;
                    }
                    else
                    {
                        deltaPending = null;
                        documentPending = null;
                    }
                }

            });


            socket.on('selectionChange', function(range) {


                var cursor = document.getElementById('cursor');


                if (!range)
                {
                    console.log('User lost focus');

                    cursor.style.display = 'none';
                }
                else
                {
                    var bounds = quill.getBounds(range.index, range.length);

                    cursor.style.display = 'inline-block';

                    if (range.length == 0)
                    {
                        console.log('Cursor', bounds);
                    }
                    else if (range.length > 0)
                    {
                        console.log('Selection', bounds);
                    }

                    cursor.style.left = (bounds.left - 2) + 'px';
                    //cursor.style.right = bounds.right + 'px';
                    cursor.style.top = (bounds.top  - 2) + 'px';
                    //cursor.style.bottom = (bounds.bottom + 2) + 'px';

                    cursor.style.width = Math.max(3, bounds.width) + 'px';
                    cursor.style.height = (bounds.height + 5) + 'px';
                }

            });
        }
    </script>
</head>

<body>

    <div class="container">
        <div id="cursors" class="cursors"><div id="cursor" class="cursor"></div></div>
        <div id="editor" class="editor"></div>
    </div>

</body>
</html>
